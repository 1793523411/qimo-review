# 死锁

>在两个或多个并发进程中，如果每个进程持有某种资源而又都等待着别的进程释放它或它们现在保持着的资源，否则就不能向前推进。此时，称这一组进程产生了死锁

+ 参与死锁的进程最少是两个
+ 两个以上进程才会出现死锁
+ 参与死锁的进程至少有两个已经占有资源
+ 参与死锁的所有进程都在等待资源
+ 参与死锁的进程是当前系统中所有进程的子集

## 死锁的起因和条件

**原因**：
+ 系统资源不足
+ 进程推进顺序非法

![](/os2-15.jpg)

**必要条件**

+ 互斥条件： 涉及的资源是非共享的，即为临界资源。
+ 不剥夺条件： 进程所获得的资源在未使用完毕之前，不能被其他进程强行夺走。
+ 部分分配： 进程每次申请它所需要的一部分资源。在等待一新资源的同时，进程继续占用已分配到的资源。
+ 环路条件：存在一种进程的循环链，链中的每一个进程已获得的资源同时被链中下一个进程所请求。

::: tip | 
这四个必要条件中只要有一个条件不满足，都不会形成“死锁”
:::

## 处理死锁

+ 预防死锁：通过设置某些限制条件，以破坏产生死锁必要条件中的一个或几个来预防死锁的产生；
+ 避免死锁：这是通过在资源的动态分配过程中，使用某种方法去防止系统进入不安全状态，从而避免了死锁的产生；
+ 检测死锁：这种方法是在死锁出现时通过系统设置的检测机构来及时地检测出死锁，并精确地确定出与死锁有关的进程和资源，然后采取适当措施，从系统中清除所发生的死锁；
+ 解除死锁：这是与检测死锁相配套的一种设施，用于将进程从死锁状态下解脱出来。常用方法是撤消或挂起一些进程，以便释放一些资源，再将这些资源分配给已处于阻塞状态的进程，使之转为就绪状态以继续执行。    

![](/os2-14.png)

### 预防死锁

由于死锁产生的必要条件中(1)是设备的固有特性，不仅不能改变之，还要设法加以保证。因此，只能通过让从(2)、(3)、(4) 条件中之一不成立上考虑

**摒弃“请求和保持”条件**

为了摒弃这一条件，系统要求所有进程一次性地申请其所需的全部资源。

+ 优点：简单、易于实现，且比较安全。
+ 缺点：(1)资源浪费严重；    (2)进程延迟执行。

**摒弃“不剥夺”条件**

该策略规定，一个已保持了某些资源的进程，若新资源要求不能立即得到满足，必须释放已保持的所有资源，以后需要时再重新申请

打破“不剥夺”条件有如下缺点：
+ (1)实现困难且代价太大； 
+ (2)会延长进程周转时间、增加系统开销和降低系统吞吐率。

**摒弃“环路等待”条件**

在该策略中，将所有的系统资源按类型进行线性排队，并赋予不同的序号。所有进程对资源的请求严格按资源序号递增顺序提出，这样在所形成的资源分配图中不可能出现环路，从而使“环路等待”条件不成立，最终可以避免死锁的产生。为什么？    

采用资源顺序分配法，可以破坏循环等待条件。该方法首先给系统中的资源编号 (唯一)，每个进程只能按序号由小到大的顺序申请资源，而且对它所必须使用的且属于某一类的所有资源，必须一次申请完。


缺点：

+ (1)为系统中各种资源类型分配序号时，必须相对稳定，从而限制了新设备的增加；
+ (2)会出现作业使用的资源顺序与系统规定的顺序不同的情况，造成资源的浪费。
+ (3)限制了用户简单、自由地编程

### 避免死锁

**避免死锁的实质就是如何使系统不进入不安全状态**

在避免死锁的方法中，允许进程动态地申请资源，但系统在进行资源分配之前，应先计算此次资源分配的安全性。若此次分配不会导致系统进入不安全状态，则将资源分配给进程； 否则，令进程等待

安全状态：是指系统能按某种进程顺序如`<P1，P2，…，Pn>` (称`<P1，P2，…，Pn>`序列为安全序列)，来为每个进程分配其所需资源，直至最大需求，使每个进程都可以顺利完成。

不安全状态：是指系统找不到一个进程安全序列`<P1，P2，…，Pn>`，当为每个进程分配其所需资源后，能使每个进程可以顺利完成

::: tip | 
死锁预防是：设法至少破坏产生死锁的三个必要条件之一，严格地防止死锁的出现。总的说来都施加了较强的限制条件，从而使实现较简单，却严重地损害了系统性能。

而死锁的避免则：不那么严格地限制产生死锁的必要条件的存在（因为即使死锁必要条件成立，也未必一定会发生死锁），而是在系统运行过程中小心地避免死锁的最终发生，因而有可能获得令人满意的系统性能。

:::

#### 银行家算法避免死锁 

申请者事先说明对各类资源的最大需求量。在进程活动期间动态申请某类资源时，由系统审查现有该类资源的数目是否能满足当前进程的最大需求量，如能满足就予以分配，否则拒绝

+ 允许进程动态地申请资源，即：需要时再申请，且不需按任何资源次序申请。
+ 但：系统在进行每次资源分配以前，都需要先运行银行家算法，计算此次资源分配的安全性。
+ 该算法对于进程发出的每一个系统能够满足的资源申请命令加以动态检查。
+ 如果发现分配资源后，系统进入不安全状态，则不予分配；
+ 而分配资源后，系统仍处于安全状态，则分配资源。
+ 所以，死锁避免策略主要是：根据系统是否处于安全状态，来决定分配资源与否。

特点：

+ 允许互斥、部分分配和不可抢占，可提高资源利用率；
+ 要求事先说明最大资源要求，在现实中很困难
