# 主存管理

物理地址 (绝对地址、实地址) :物理地址是计算机主存单元的真实地址，又称为绝对地址或实地址

逻辑地址 (相对地址、虚地址) :用户的程序地址 (指令地址或操作数地址)均为逻辑地址

主存管理功能:地址映射,主存分配 ,存储保护,主存扩充

## 地址映射

将程序地址空间中使用的逻辑地址变换成主存中的物理地址的过程，称为地址映射

- 重定位原因：当程序装入内存时, 操作系统要为该程序分配一个合适的内存空间，由于程序的逻辑地址与分配到内存物理地址不一致, 而 CPU 执行指令时，是按物理地址进行的，所以要进行地址转换
- 重定位方式：分为静态重定位和动态重定位

在程序装入过程中随即进行的地址变换方式称为静态地址映射（静态重定位）

在程序执行期间，随着每条指令和数据的访问自动地连续地进行地址映射，这种地址变换方式称为动态地址映射（动态重定位）

|    静态地址映射     |    动态地址映射    |
| :-----------------: | :----------------: |
|  在程序装入过程中   |   在程序执行期间   |
|    进行地址映射     |    进行地址映射    |
|       需软件        | 需硬件地址变换机构 |
|  (重定位装入程序)   |  ( 重定位寄存器)   |
| 需花费较多 CPU 时间 |     地址变换快     |
|       不灵活        |        灵活        |

## 主存分配

- (1) 构造分配用的数据结构：登记内存分配情况
- (2) 制定策略
  - ① 放置策略 —— 空闲区分配原则
  - ② 调入策略 —— 决定信息装入主存的时机
    - 预调策略：预先将信息调入主存
    - 请调策略：当需要信息时，将信息调入主存
  - 淘汰策略 —— 在主存中没有可用的空闲区 (对某一程序而言)时，决定哪些信息从主存中移走，即确定淘汰已占用的内存区的原则。
- (3) 实施主存分配与回收

## 主存扩充

**实现方法**

- 程序的全部代码和数据存放在辅存中；
- 将程序当前执行所涉及的那部分程序代码放入主存中；
- 程序执行时，当所需信息不在主存，由操作系统和硬件相配合来完成主存从辅存中调入信息，程序继续执行

**虚拟存储器**

- 通过操作系统利用程序执行的局部性，在内存和外存之间通过不断交换信息，构成一个容量超过内存物理容量的由外存和内存共同组成的虚拟存储器
- 与实际物理存储器只有一个（单机系统中），且被所有进程共享不一样，每个进程都拥有自己的虚拟存储器，且虚拟存储器的容量是由计算机的地址结构和寻址方式确定的。若 CPU 给出的有效地址长度为 18 位,可以寻址范围为:0--256k;若地址的长度为 20 位,则寻址范围为:1024k.
- 实现虚拟存储器的物质基础
  - 有相当容量的辅存： 足以存放应用程序的虚地址空间
  - 地址变换机构

## 存储共享和保护

- 内存共享是为了更有效利用内存
- 内存保护是为了保证在内存中的多道程序只能在给定的存储区域内活动并互不产生干扰。 包括：
  - 防止地址越界：界地址保护
  - 防止越权(对共享区有访问权)

## 存储器管理方式

- 连续分配方式：指为程序分配一个连续的空间，主要有：
  - 单一连续区管理方式
  - 分区管理方式：通常可分为固定分区方式和可变分区方式
- 离散分配方式：为了减少因连续分配所产生的碎片，提高内存的利用率产生了离散分配方式，它可将一个用户程序离散地分配到内存中的多个不相连接的区域中。其方式有：
  - 分页存储管理方式
  - 分段存储管理方式
  - 段页式存储管理方式
- 虚拟存储管理方式：为了进一步提高内存利用率，又形成了一种虚拟存储管理方式。其方式有
  - 请求分页管理方式
  - 请求分段管理方式
  - 请求段页式管理方式

## 分区存储管理

![](/os2-19.jpg)

动态分区分配 :存储空间分配是在程序装入内存时进行，按照用户请求的大小分配分区

动态分区的分配、回收过程

![](/os2-20.jpg)

![](/os2-21.jpg)

**分区分配思路**

- 寻找空闲块:依申请者所要求的主存区的大小，分区分配程序在自由主存队列中找一个满足用户需要的空闲块；
- 若找到了所需的空闲区，有两种情况
  - 空闲区与要求的大小相等，将该空闲区分配并从队列中摘除；
  - 空闲区大于所要求的的大小，将空闲区分为两部分：一部分成为已分配区，建立已分配区的描述器；剩下部分仍为空闲区。返回所分配区域的首址；
- 否则，告之不能满足要求。

**分区回收思路**

- 检查释放分区 (即为回收分区)在主存中的邻接情况:若上、下邻接空闲区，则合并，成为一个连续的空闲区
- 若回收分区不与任何空闲区相邻接:建立一个新的空闲区，并加入到空闲区队列中。

放置策略:选择空闲区的策略，称为放置策略

**常用的放置策略**:

- 首次匹配 (首次适应算法):地址由低到高满足要求的空闲区,空闲区地址由低到高排序,大的空闲区保留在搞地址端

- 最佳匹配 (最佳适应算法):满足要求的最小空闲区,空闲区由小到大排序大的,空闲区得以保留

- 最坏匹配 (最坏适应算法):选择满足要求的最大空闲区中,空闲区大小由大到小排序,无法满足大作业的需求。

首次适应算法：空闲区按物理地址递增排列。

最佳适应算法：空闲区按空间大小递增排列。

最坏适应算法：空闲区按空间大小递减排列

碎片:在已分配区之间存在着的一些没有被充分利用的空闲区

拼接技术

## 页式存储管理

逻辑页面:程序的地址空间等分，称为逻辑页面，又称为虚页

主存块:存被等分成大小相等的块，称为主存块，又称为物理页面

### 页式地址变换

**页表**

- 系统为每个进程建立一张页面映射表，简称页表。
- 页表保存于内存。
- 每个逻辑页在页表中占一个表项，记录该页在内存中对应的物理块号。
- 进程在执行时，通过查找页表，就可以找到每页所对应的物理块号。可见，页表的作用是实现从页号到物理块号的地址映射。

**虚地址结构**

当 CPU 给出的虚地址长度为 16 位，页面大小为 1KB 时，在分页系统中地址结构的格式如下

![](/os2-22.jpg)

**页式地址变换过程**

![](/os2-23.jpg)
![](/os2-24.jpg)

- ⅰ CPU 给出操作数地址 (为 2500) ；
- ⅱ 由分页机构自动地把逻辑地址分为两部分，得到页号 p 和页内相对位移 w (p =2， w =452)；
- ⅲ 根据页表始址寄存器指示的页表始地址，以页号为索引，找到第 2 页所对应的块号 (为 7) ；
- ⅳ 将块号 b 和页内位移量 w 拼接在一起，就形成了访问主存的物理地址 (71024+452=7620)

::: tip | 块表
为什么引入快表？---解决“两次访内”问题

缓冲存储器中存放正在运行的进程当前用到的页号和对应的块号，又称为快表
:::

### 分页存储管理基本原理

- 等分主存：把主存划分成相同大小的存储块。
- 用户逻辑地址空间的分页：逻辑地址空间划分成与物理页大小相同的部分。
- 逻辑地址的表示：虚拟地址 A=>（p,d）
- 主存分配原则：系统以物理页为单位把主存分给作业或进程，并且分给一个作业或进程的物理页不一定是相邻和连续的。

虚拟存储器概念: ① 简单页式系统：装入一个程序的全部页面才能投入运行。 ② 请求页式系统： 装入一个程序的部分页面即可投入运行,请求页式系统解决了虚拟存储问题。

- 引入：常规方式下“一次性”和“驻留性”
- 依据：程序局部性
- 特征：多次性、对换性、虚拟性
- 实现方法：虚拟页式、虚拟段式、虚拟段页式

所谓虚拟存储器， 是指具有请求调入功能和置换功能， 能从逻辑上对内存容量加以扩充的一种存储器系统。其逻辑容量由内存容量和外存容量之和所决定，其运行速度接近于内存，而每位的成本又接近于外存。

必须建立在离散分配的内存管理技术基础上。

请求分页系统:基本分页系统 + 请求调页功能 + 页面置换功能＝页式虚拟存储系统

硬件支持：请求分页的页表机制、缺页中断机构、动态地址变换机构。

软件支持：请求分页、页面置换

中断位 i ： 标识该页是否在主存,若 i=1，表示此页不在主存；若 i=0，表示该页在主存

辅存地址 ：该页面在辅存的位置

缺页中断与一般中断的区别：

- 在指令执行期间产生和处理中断信号。
- 一条指令在执行期间，可能产生多次缺页中断。

**缺页处理过程图示**

![](/os2-17.png)

### 淘汰策略

用来选择淘汰哪一页的规则叫做置换策略，或称淘汰算法

**扩充页表功能 —— 引用位 改变位**

![](/os2-25.jpg)

抖动:颠簸(thrashing)，又称为“抖动”。 简单地说，导致系统效率急剧下降的主存和辅存之间的, 频繁页面置换现像称为“抖动”。

假定程序 p 共有 n 页，系统分配 m 块，且 `1≤m≤n`； 若程序 p 在运行中：成功的访问次数为 s，不成功的访问次数为 f；缺页中断率： `f′=f/ (s+ f)`

**置换算法**

最佳算法(OPT 算法) :选择永不再被使用或很久才被访问的页面淘汰。

特点：

- 理论上，性能最佳；
- 实际上，无法实现；
- 通常用该算法来评价其他算法的优劣

先进先出淘汰算法(FIFO 算法):总是选择在主存中居留时间最长 (即最早进入主存)的一页淘汰

特点：

- 算法简单，实现容易
- 性能差，存在 belady 异常（当物理块数增加时，缺页次数增加。）

最近最久未使用淘汰算法(LRU 算法):总是选择最长时间未被使用的那一页淘汰。

最久未使用淘汰算法的实现:

- 用引用位考察页面的使用情况；
- 当访问页面时，将引用位置 1，并记时；
- 当要淘汰一页时，选择时间最长的一页淘汰。要精确实现很困难
- 硬件方法：采用计数器
- 软件方法：采用页号栈

## 段页式存储管理

段:分段是程序中自然划分的一组逻辑意义完整的信息集合。分段的例：代码分段、数据分段、栈段页。

程序地址空间:由若干个逻辑分段组成，每个分段有自己的名字，对于一个分段而言，它是一个连续的地址区

![](/os2-27.jpg)

### 页式系统与段式系统的区别

(1) 用户地址空间的区别

① 页式系统中用户地址空间： 一维地址空间

② 段式系统中用户地址空间： 二维地址空间

(2) 分段和页面的区别

|      分段      |       页面       |
| :------------: | :--------------: |
| 信息的逻辑划分 |  信息的物理划分  |
|  段长是可变的  | 页的大小是固定的 |
|    用户可见    |    用户不可见    |
|  方便程序共享  |  提高内存利用率  |

在段式存储管理中结合分页存储管理技术，在一个分段内划分页面，就形成了段页式存储管理

### 段表、页表与主存的关系

![](/os2-26.jpg)