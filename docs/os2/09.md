# 文件管理

## 文件系统基本概念

文件：文件是在逻辑上具有完整意义的信息集合，它有一个名字以供标识，文件名是以字母开头的字母数字串

文件系统 ：操作系统中与管理文件有关的软件和数据称为文件系统。它负责管理文件的存储、检索、更新，提供安全可靠的共享和保护手段，并且方便用户使用

从系统的角度看：文件系统是一个负责文件存储空间管理的机构。从用户的角度看：文件系统是用户在计算机上存储信息、和使用信息的接口

## 文件结构

**文件的逻辑结构**

逻辑文件：从用户角度看到的文件面貌。即用户对信息进行逻辑组织形成的文件结构

研究文件逻辑结构的目的：

- 为用户提供一种逻辑结构清晰、使用简便的逻辑文件形式。
- 用户按文件的逻辑结构形式去存储、检索和加工文件中的信息。

流式文件： 流式文件是相关的有序字符的集合，是无结构的

记录式文件：记录式文件是一种有结构的文件。这种文件在逻辑上总是被看成一组连续顺序的记录的集合

文件的存取方法：

顺序存取：后一次存取总是在前一次存取的基础上进行的。顺序存取时不必给出具体的存取位置

随机存取：用户以任意次序请求某个记录。随机存取时要指出起始存取位置 (例如记录号)。

**文件的物理结构**

物理文件：文件的物理结构是信息在物理存储器上的存储方式，是数据的物理表示和组织

研究文件物理结构的目的：

- 选择工作性能良好、设备利用率高的物理文件形式。
- 系统按照文件的物理结构形式和外部设备打交道，控制信息的传输。

连续文件：

- 定义：连续文件结构是由一组分配在磁盘连续区域的物理块组成的
- 结构：文件Ａ有三个记录 (逻辑记录与物理块大小相等，都为 512 Ｂ)，采用连续文件结构，r0 存放在块号为 100 的磁盘块上
- 特点：
  - 连续存取时速度较快
  - 文件长度一经固定便不易改变
  - 不利于文件内容的插入和删除

串联文件:

- 定义：串联文件结构是按顺序由串联的块组成的，即文件的信息存于若干块物理块中，每个物理块的最末一个字作为链接字，它指出后继块的物理地址。文件的最后一块的链接字为结束标记“”，它表示文件至本块结束
- 结构：
- ![](/os2-21.png)
- 特点：
  - 能较好地利用辅存空间
  - 易于对文件进行增生和扩充
  - 不利于随机存取

索引文件:

- 定义：系统为每个文件建立逻辑块号与物理块号的对照表。这张表称为该文件的索引表。文件由数据文件和索引表构成。这种文件称为索引文件
- 结构：![](/os2-22.png)
- 特点：
  - 易于文件的增删
  - 直接读写任意记录

**索引表的组织——多级索引**

直接索引:

![](/os2-23.png)

一级间接索引结构:

![](/os2-24.png)

二级间接索引结构:

![](/os2-25.png)

## 文件目录

文件目录是记录文件的名字、存放地址及其他有关文件的说明信息和控制信息的数据结构

文件目录项内容:

- 文件名
- 文件逻辑结构
  - 说明该文件的记录是否定长、记录长度及记录个数等
- 文件物理结构：记录文件的物理结构形式
  - 连续文件——指出文件第一块的物理地址、文件所占块数
  - 串联文件——指出该文件第一块的物理地址
  - 索引文件——指出索引表地址
- 存取控制信息
  - 文件主具有的存取权限、核准的其他用户及其相应的存取权限
- 管理信息
  - 文件建立日期、时间，上一次存取时间、要求文件保留的时间等
- 文件类型
  - 文件的类型，例如可分为数据文件、目录文件、块存储设备文件、
  - 字符设备文件

重名问题:所谓“重名”，是指不同用户对不同文件起了相同的名字，即两个或多个文件只有一个相同的符号名。又称为命名冲突。

解决办法:为了解决命名冲突、获得更灵活的命名能力，文件系统必须采用多级目录结构

树型文件目录:在多级目录系统中 (除最末一级外)，任何一级目录的目录项可以描述一个目录文件，也可以描述一个非目录文件 (数据文件)，**而数据文件一定在树叶上**。这样，就构成了一个树形层次结构

![](/os2-26.png)

文件路径名:多级目录中，文件的路径名是由根目录到该文件的通路上所有目录文件符号名和该文件的符号名组成的字符串，相互之间用分隔符分隔

![](/os2-27.png)

当前目录:

+ 当前目录是当前用户正在使用的文件所在的目录。
+ 当指定当前目录后，用户对文件的所有访问都是相对于“当前目录”进行的。 这时，文件路径名是由“当前目录”到信息文件的通路上所有各级目录的符号名加上该信息文件的符号名组成。
+ 查找一个文件可从当前目录开始，使用部分路径名。
+ 当前目录可根据需要任意改变。
+ 当前目录一般存放在内存

## 文件共享与安全

文件共享 :文件共享是指某一个或某一部分文件可以让事先规定的某些用户共同使用

文件共享---链接技术:所谓“链接”，就是在相应目录表目之间进行链接，即个目录中的表目直接指向另一个目录表目所在的物理位置,注意，这种链接不是直接指向文件，而是指向相应的目录表目。这种办法也称为连访，被共享的文件称为连访文件

文件安全的定义:所谓文件安全，就是文件的保护问题.文件的保护是指文件本身不得被未经文件主授权的任何用户存取，而对于授权用户也只能在允许的存取权限内使用文件

存取权限验证方法:

+ ⅰ 访问控制矩阵
+ ⅱ 存取控制表
+ ⅲ 用户权限表
+ ⅳ 口令
+ ⅴ 密码

## 文件操作与文件备份

常用的文件操作命令
```
create	 创建一个新文件
delete	 从系统目录中撤消一个文件
rename	 在系统目录中改变文件的名字
open	 打开文件,在用户和文件(或设备)之间建立一个逻辑通路
close	 关闭文件,在用户和文件(或设备)之间撤消一个逻辑通路
write	 写到一个文件(或设备)上
read	 从一个文件(或设备)读入数据信息	
```

“打开文件”:所谓打开文件就是把该文件的有关目录表目复制到主存中约定的区域，建立文件控制块，建立用户和这个文件的联系

“关闭文件”:所谓关闭文件就是用户宣布这个文件当前不再使用，系统将其在主存中的文件控制块删去，因而也就切断了用户同这个文件的联系

文件备份:为了能在软、硬件失效的意外情况下恢复文件，保证文件的完整性、数据的连续可利用性，文件系统提供适当的机构，以便复制备份

常用的两种文件备份方法：
+ 周期性备份:按固定的时间周期把存储器中所有文件的内容转存到某种介质上，通常是磁带或磁盘。在系统失效时，使用这些转存磁盘或磁带，将所有文件重新建立并恢复到最后一次转存时的状态
+ 增量转储:这种技术转储的只是从上次转储以后已经改变过的信息；增量转储的信息量较小，故转储可在更短的时间周期内进行

## 文件存储空间的管理 

### 空闲表法

空闲表法属于连续分配方式，系统为外存上的所有空闲区建立一张空闲表，每个空闲区对应于一个空闲表项，其中包括表项序号、该空闲区的第一个盘块号、该区的空闲盘块数等信息。再将所有空闲区按其起始盘块号递增的次序排列，如图所示

分配：采用首次适应算法、循环首次适应算法等

### 空闲链表法

空闲链表法是将所有空闲盘区拉成一条空闲链。根据构成链所用基本元素的不同，可把链表分成两种形式：空闲盘块链和空闲盘区链

空闲盘块链。这是将磁盘上的所有空闲空间，以盘块为单位拉成一条链。当用户因创建文件而请求分配存储空间时，系统从链首开始，依次摘下适当数目的空闲盘块分配给用户。当用户因删除文件而释放存储空间时，系统将回收的盘块依次插入空闲盘块链的末尾。这种方法的优点是用于分配和回收一个盘块的过程非常简单，但在为一个文件分配盘块时，可能要重复操作多次

空闲盘区链。这是将磁盘上的所有空闲盘区(每个盘区可包含若干个盘块)拉成一条链。在每个盘区上除含有用于指示下一个空闲盘区的指针外，还应有能指明本盘区大小(盘块数)的信息。分配盘区的方法与内存的动态分区分配类似，通常采用首次适应算法。在回收盘区时，同样也要将回收区与相邻接的空闲盘区相合并。在采用首次适应算法时，为了提高对空闲盘区的检索速度，可以采用显式链接方法，亦即，在内存中为空闲盘区建立一张链表

### 位示图法

位示图是利用二进制的一位来表示磁盘中一个盘块的使用情况。当其值为“0”时，表示对应的盘块空闲；为“1”时，表示已分配。有的系统把“0”作为盘块已分配的标志，把“1”作为空闲标志

磁盘上的所有盘块都有一个二进制位与之对应，这样，由所有盘块所对应的位构成一个集合，称为位示图

优点：

+ 从位示图中很容易找到一个或一组相邻接的空闲盘块。例如，我们需要找到6个相邻接的空闲盘块，这只需在位示图中找出6个其值连续为“0”的位即可。
+ 由于位示图很小，占用空间少，因而可将它保存在内存中，进而使在每次进行盘区分配时，无需首先把盘区分配表读入内存，从而节省了许多磁盘的启动操作

